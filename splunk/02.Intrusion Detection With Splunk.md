- check log sources - `index="main" | stats count by sourcetype`
- parent children where children is ps or cmd - `index="main" sourcetype="WinEventLog:Sysmon" EventCode=1 (Image="*cmd.exe" OR Image="*powershell.exe") | stats count by ParentImage, Image`
- check for suspicious connections - `index="main" 10.0.0.229 sourcetype="WinEventLog:sysmon" | stats count by CommandLine`
- DCSync attack check - `index="main" EventCode=4662 Access_Mask=0x100 Account_Name!=*$`
- check what accessed "lsass" - `index="main" EventCode=10 lsass | stats count by SourceImage`

## Creating Meaningful Alerts
### create an alert that can detect threat actors based on them making calls from UNKNOWN memory regions
- listing all the call stacks containing UNKNOWN - `index="main" CallTrace="*UNKNOWN*" | stats count by EventCode`
- group by SourceImage - `index="main" CallTrace="*UNKNOWN*" | stats count by SourceImage`
- filter process accessing itself -  `index="main" CallTrace="*UNKNOWN*" | where SourceImage!=TargetImage | stats count by SourceImage`
- filter C and .NET - `index="main" CallTrace="*UNKNOWN*" SourceImage!="*Microsoft.NET*" CallTrace!=*ni.dll* CallTrace!=*clr.dll* | where SourceImage!=TargetImage | stats count by SourceImage`
- filter WOW64 - `index="main" CallTrace="*UNKNOWN*" SourceImage!="*Microsoft.NET*" CallTrace!=*ni.dll* CallTrace!=*clr.dll* CallTrace!=*wow64* | where SourceImage!=TargetImage | stats count by SourceImage`
- filter Explorer.exe - `index="main" CallTrace="*UNKNOWN*" SourceImage!="*Microsoft.NET*" CallTrace!=*ni.dll* CallTrace!=*clr.dll* CallTrace!=*wow64* SourceImage!="C:\\Windows\\Explorer.EXE" | where SourceImage!=TargetImage | stats count by SourceImage`

## Misc
- `index=* (ImageLoaded="*clr.dll*" OR ModuleLoaded="*clr.dll*") | table _time, host, User, ParentImage, Image, ImageLoaded, CommandLine`
- `index=* EventCode=3  | stats count by dest_ip, dest_port, Image, CommandLine | where like(Image, "%SharpHound.exe%") OR like(Image, "%rundll32.exe%") OR like(Image, "%powershell.exe%") OR like(CommandLine, "%beacon%") OR dest_port=4444 OR dest_port=8080 OR dest_port=1337`
